<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/">Home</a>
                    </li>
                </ul>
            </div>
            <span class="navbar-text mx-auto fw-bold">CREDITIA</span>
        </div>
    </nav>

    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <div class="text-center mb-4">
            <h1>Reporte Creditia Maga</h1>
        </div>
        <input type="file" id="csvInput" class="form-control mb-3">
        <button onclick="processExcel()" class="btn btn-primary">Procesar Archivo</button>
        <button onclick="downloadExcel()" class="btn btn-success mt-2">Descargar Excel</button>
        <pre id="output" class="mt-3" style="background: #f8f9fa; padding: 10px; border: 1px solid #ddd;"></pre>
    </div>

    <script>
        "use strict";

        let processedData = [];

        const headersTemplate = [
            "DNI",
            "TELEFONO",
            "TIPO DE CONTACTO",
            "RESULTADO DE GESTION",
        ];

        // Palabras/expresiones a excluir (no se recrea por fila)
        const EXCLUDED_KEYWORDS = [
            "bienvenida",
            "aviso",
            "bienvenida-maga",
            "envio de acuerdo-maga",
            "bienvenida-welp fasa",
            "bienvenida-capta",
            "bienvenida-clearing",
            "recordatorio de cuota-maga",
            "recordatorio de cuota-welp fasa",
            "recordatorio de cuota-capta",
            "recordatorio de cuota-clearing",
            "envio de acuerdo-welp fasa",
            "envio de acuerdo-capta",
            "envio de acuerdo-clearing",
            "reasignacion a usuario",
            "baja por pedido de entidad",
            "cancelacion anterior",
            "alta nuevo mail",
            "edición de pago a imputar",
            "anotacion",
            "intimacion-maga-urgente",
            "intimacion-capta-urgente",
            "bienvenida-maga-exc",
            "envio de acuerdo-maga-exc",
            "recordatorio de cuota-maga-exc",
            "intimación-maga-e-urgente"
        ];

        const gestionMapping = {
            "Acuerdo cumplido": "Ubicado - con acuerdo de pago",
            "Acuerdo libre": "Ubicado - con acuerdo de pago",
            "Acuerdo en cuota/s": "Ubicado - con acuerdo de pago",
            "Bajo acuerdo": "Ubicado - acuerdo incumplido",
            "Cancelado": "Ubicado - cancelados",
            "Confirma acuerdo": "Ubicado - con acuerdo de pago",
            "Contactado": "Ubicado - sin acuerdo de pago",
            "Dice que pago": "Ubicado - con acuerdo de pago",
            "Equivocado": "No Ubicado - busqueda negativa",
            "Fallecido": "No Ubicado - fallecido",
            "Fuera de servicio": "No Ubicado - busqueda negativa",
            "Imposibilidad inmediata de pago": "Incobrable - sin posibilidad de pago",
            "Imposible ubicar titular": "No Ubicado - busqueda negativa",
            "Mensaje contestador": "No Ubicado - mensaje a terceros",
            "Mensaje directo": "No Ubicado - mensaje a terceros",
            "Mensaje indirecto": "No Ubicado - mensaje a terceros",
            "No contesta": "No Ubicado - busqueda negativa",
            "No reconoce deuda": "Incobrable - sin intencion de pago",
            "No tiene voluntad de arreglo": "Incobrable - sin intencion de pago",
            "Pago a imputar": "Ubicado - con acuerdo de pago",
            "Cambio de linea": "No Ubicado - busqueda negativa",
            "No tiene dinero": "Ubicado - sin acuerdo de pago",
            "Ocupado": "No Ubicado - busqueda negativa",
            "Se mudo": "No Ubicado - busqueda negativa",
            "ENVIO DE IVR": "No Ubicado - busqueda negativa",
        };

        function processExcel() {
            const fileInput = document.getElementById("csvInput");
            const file = fileInput.files[0];

            if (!file) {
                alert("Por favor, selecciona un archivo Excel.");
                return;
            }

            if (!file.name.endsWith(".xlsx") && !file.name.endsWith(".xls")) {
                alert("Por favor, selecciona un archivo Excel válido.");
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                    processedData = construirFilasProcesadas(jsonData);

                    const hayResultadosNoContemplados = processedData.some(row =>
                        row["RESULTADO DE GESTION"] === "sin resultado valido"
                    );

                    if (hayResultadosNoContemplados) {
                        alert("Hay resultados nuevos que no contemplaste.");
                    }

                    // Mostrar solo un preview para no matar el navegador
                    const output = document.getElementById("output");
                    if (!processedData.length) {
                        output.textContent = "No se encontraron registros que cumplan las condiciones.";
                    } else {
                        const preview = processedData.slice(0, 20);
                        output.textContent =
                            `Registros procesados: ${processedData.length}\n\n` +
                            JSON.stringify(preview, null, 2);
                    }
                } catch (error) {
                    console.error("Error procesando el archivo Excel:", error);
                    alert("Hubo un error procesando el archivo.");
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function construirFilasProcesadas(jsonData) {
            const resultadoFinal = [];

            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];

                // Entidad CAPTA CREDITIA
                if (row["entidades_35_cDescripcio"] !== "CAPTA CREDITIA") continue;

                const resultadoOriginal = row["resultados_22_cDescripcio"] || "";
                const resultadoLower = resultadoOriginal.toLowerCase();

                // Excluir explícitos
                if (
                    resultadoOriginal === "Edición de pago a imputar" ||
                    resultadoOriginal === "Anotacion" ||
                    resultadoOriginal === "anotacion"
                ) {
                    continue;
                }

                // Excluir si contiene "de acuerdo" o "de cuenta"
                if (resultadoLower.includes("de acuerdo") || resultadoLower.includes("de cuenta")) continue;

                // Excluir por palabras clave
                let excluidoPorKeyword = false;
                for (let j = 0; j < EXCLUDED_KEYWORDS.length; j++) {
                    if (resultadoLower.includes(EXCLUDED_KEYWORDS[j])) {
                        excluidoPorKeyword = true;
                        break;
                    }
                }
                if (excluidoPorKeyword) continue;

                // Excluir si contiene "aviso"
                if (resultadoLower.includes("aviso")) continue;

                // Teléfono: solo números
                const telefono = row["gestiones_cTelDiscad"];
                if (!telefono || /[^0-9]/.test(String(telefono))) {
                    continue;
                }

                const processedRow = {};

                // DNI
                processedRow["DNI"] = row["personas_nNumeDocu"];

                // TELEFONO
                processedRow["TELEFONO"] = telefono;

                // TIPO DE CONTACTO
                const tipoContacto = row["tipocont_19_cDescripcio"];
                if (tipoContacto === "TITULAR") {
                    processedRow["TIPO DE CONTACTO"] = "TITULAR";
                } else if (tipoContacto && String(tipoContacto).toLowerCase().includes("laboral")) {
                    processedRow["TIPO DE CONTACTO"] = "LABORAL";
                } else {
                    processedRow["TIPO DE CONTACTO"] = "TERCERO";
                }

                // RESULTADO DE GESTION usando mapping
                processedRow["RESULTADO DE GESTION"] =
                    gestionMapping[resultadoOriginal] || "sin resultado valido";

                // Asegurar todos los headers
                for (let k = 0; k < headersTemplate.length; k++) {
                    const header = headersTemplate[k];
                    if (!Object.prototype.hasOwnProperty.call(processedRow, header)) {
                        processedRow[header] = "";
                    }
                }

                // Ordenar columnas según headersTemplate
                const orderedRow = {};
                for (let k = 0; k < headersTemplate.length; k++) {
                    const header = headersTemplate[k];
                    orderedRow[header] = processedRow[header] || "";
                }

                resultadoFinal.push(orderedRow);
            }

            return resultadoFinal;
        }

        async function downloadExcel() {
            if (!processedData.length) {
                alert("No hay datos procesados para exportar.");
                return;
            }

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Datos");

            // Configurar columnas
            worksheet.columns = headersTemplate.map(header => {
                if (header === "DNI" || header === "TELEFONO") {
                    return { header, key: header, width: 15, style: { numFmt: "0" } };
                }
                return { header, key: header, width: 25 };
            });

            // Estilos cabecera
            const headerStyle = {
                font: { bold: true, color: { argb: "FFFFFFFF" } },
                fill: { type: "pattern", pattern: "solid", fgColor: { argb: "FF000000" } },
                alignment: { horizontal: "center" },
                border: {
                    top: { style: "thin" },
                    left: { style: "thin" },
                    bottom: { style: "thin" },
                    right: { style: "thin" }
                }
            };

            worksheet.getRow(1).eachCell(cell => {
                cell.style = headerStyle;
            });

            // Agregar filas respetando el orden
            for (let i = 0; i < processedData.length; i++) {
                const rowObj = processedData[i];
                const rowValues = headersTemplate.map(h => rowObj[h]);
                worksheet.addRow(rowValues);
            }

            // Bordes y wrapText
            worksheet.eachRow(row => {
                row.eachCell(cell => {
                    cell.border = {
                        top: { style: "thin" },
                        left: { style: "thin" },
                        bottom: { style: "thin" },
                        right: { style: "thin" }
                    };
                    cell.alignment = { vertical: "middle", wrapText: true };
                });
            });

            const fileName = "ReporteCapta.xlsx";

            try {
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob(
                    [buffer],
                    { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }
                );
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Error generando el Excel:", error);
                alert("Ocurrió un error generando el Excel.");
            }
        }
    </script>

</body>

</html>
