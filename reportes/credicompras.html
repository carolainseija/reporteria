<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/">Home</a>
                    </li>
                </ul>
            </div>
            <span class="navbar-text mx-auto fw-bold">CREDICOMPRAS</span>
        </div>
    </nav>

    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <div class="text-center mb-4">
            <h1>Reporte Credicompras Maga</h1>
        </div>
        <input type="file" id="csvInput" class="form-control mb-3">
        <button onclick="processExcel()" class="btn btn-primary mb-2">Procesar Archivo</button>
        <button onclick="downloadExcel()" class="btn btn-success">Descargar Excel</button>
        <pre id="output" class="mt-3" style="background: #f8f9fa; padding: 10px; border: 1px solid #ddd;"></pre>
    </div>

    <script>
        "use strict";

        let processedData = [];

        const headersTemplate = [
            "ENTIDAD",
            "CI",
            "NOMBRE",
            "FECHA/HORA",
            "TIPO",
            "RESULTADO",
            "CONTACTO",
        ];

        // Palabras a excluir (no se recalculan por fila)
        const EXCLUDED_KEYWORDS = [
            "bienvenida",
            "aviso",
            "bienvenida-maga",
            "envio de acuerdo-maga",
            "bienvenida-welp fasa",
            "bienvenida-capta",
            "bienvenida-clearing",
            "recordatorio de cuota-maga",
            "recordatorio de cuota-welp fasa",
            "recordatorio de cuota-capta",
            "recordatorio de cuota-clearing",
            "envio de acuerdo-welp fasa",
            "envio de acuerdo-capta",
            "envio de acuerdo-clearing",
            "reasignacion a usuario",
            "baja por pedido de entidad",
            "cancelacion anterior",
            "alta nuevo mail",
            "edición de pago a imputar",
            "anotacion",
            "intimacion-maga-urgente",
            "intimacion-capta-urgente",
            "bienvenida-maga-exc",
            "envio de acuerdo-maga-exc",
            "recordatorio de cuota-maga-exc",
            "intimación-maga-e-urgente"
        ];

        // Mapeo de gestiones (igual que antes, por si lo necesitás luego)
        const gestionMapping = {
            "Acuerdo cumplido": "Ubicado - con acuerdo de pago",
            "Acuerdo libre": "Ubicado - con acuerdo de pago",
            "Acuerdo en cuota/s": "Ubicado - con acuerdo de pago",
            "Bajo acuerdo": "Ubicado - acuerdo incumplido",
            "Cancelado": "Ubicado - cancelados",
            "Confirma acuerdo": "Ubicado - con acuerdo de pago",
            "Contactado": "Ubicado - sin acuerdo de pago",
            "Dice que pago": "Ubicado - con acuerdo de pago",
            "Equivocado": "No Ubicado - busqueda negativa",
            "Fallecido": "No Ubicado - fallecido",
            "Fuera de servicio": "No Ubicado - busqueda negativa",
            "Imposibilidad inmediata de pago": "Incobrable - sin posibilidad de pago",
            "Imposible ubicar titular": "No Ubicado - busqueda negativa",
            "Mensaje contestador": "No Ubicado - mensaje a terceros",
            "Mensaje directo": "No Ubicado - mensaje a terceros",
            "Mensaje indirecto": "No Ubicado - mensaje a terceros",
            "No contesta": "No Ubicado - busqueda negativa",
            "No reconoce deuda": "Incobrable - sin intencion de pago",
            "No tiene voluntad de arreglo": "Incobrable - sin intencion de pago",
            "Pago a imputar": "Ubicado - con acuerdo de pago",
            "Cambio de linea": "No Ubicado - busqueda negativa",
            "No tiene dinero": "Ubicado - sin acuerdo de pago",
            "Ocupado": "No Ubicado - busqueda negativa",
            "Se mudo": "No Ubicado - busqueda negativa",
            "ENVIO DE IVR": "No Ubicado - busqueda negativa",
        };

        function ajustarFecha(date) {
            // Mantengo tu lógica: solo reemplazar "-" por "/"
            // Ej: "2025-05-01 09:00:16" -> "2025/05/01 09:00:16"
            if (!date) return "";
            return String(date).replace(/-/g, "/");
        }

        function processExcel() {
            const fileInput = document.getElementById("csvInput");
            const file = fileInput.files[0];

            if (!file) {
                alert("Por favor, selecciona un archivo Excel.");
                return;
            }

            if (!file.name.endsWith(".xlsx") && !file.name.endsWith(".xls")) {
                alert("Por favor, selecciona un archivo Excel válido.");
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                    processedData = construirFilasProcesadas(jsonData);

                    // Mostrar un resumen en lugar de todo el JSON (mucho más liviano)
                    const output = document.getElementById("output");
                    if (processedData.length === 0) {
                        output.textContent = "No se encontraron registros que cumplan las condiciones.";
                    } else {
                        const preview = processedData.slice(0, 20); // muestra solo los primeros 20
                        output.textContent =
                            `Registros procesados: ${processedData.length}\n\n` +
                            JSON.stringify(preview, null, 2);
                    }
                } catch (error) {
                    console.error("Error procesando el archivo Excel:", error);
                    alert("Hubo un error procesando el archivo.");
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function construirFilasProcesadas(jsonData) {
            const resultadoFinal = [];

            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];

                // Filtro entidad
                if (row["entidades_35_cDescripcio"] !== "CREDICOMPRAS") continue;

                const resultadoOriginal = row["resultados_22_cDescripcio"] || "";
                // descartar explícitos
                if (
                    resultadoOriginal === "Edición de pago a imputar" ||
                    resultadoOriginal === "Anotacion"
                ) {
                    continue;
                }

                const resultadoLower = resultadoOriginal.toLowerCase();

                // descartar si contiene "de acuerdo" o "de cuenta"
                if (resultadoLower.includes("de acuerdo") || resultadoLower.includes("de cuenta")) continue;

                // descartar por palabras clave excluidas
                let excluidoPorKeyword = false;
                for (let j = 0; j < EXCLUDED_KEYWORDS.length; j++) {
                    if (resultadoLower.includes(EXCLUDED_KEYWORDS[j])) {
                        excluidoPorKeyword = true;
                        break;
                    }
                }
                if (excluidoPorKeyword) continue;

                // descartar si resultado incluye "aviso" (mantengo tu lógica)
                if (resultadoLower.includes("aviso")) continue;

                const telefono = row["gestiones_cTelDiscad"];
                // debe ser solo números
                if (!telefono || /[^0-9]/.test(String(telefono))) {
                    continue;
                }

                // Armar fila procesada
                const processedRow = {};

                processedRow["ENTIDAD"] = "CREDICOMPRAS";
                processedRow["CI"] = row["personas_nNumeDocu"];
                processedRow["NOMBRE"] = row["personas_cContacto"];
                processedRow["FECHA/HORA"] = ajustarFecha(row["gestiones_dtFechHora"]);
                processedRow["CONTACTO"] = telefono;

                const tipoEntrada = row["entrgest_20_cDescripcio"];
                if (tipoEntrada === "LLAMADA ENTRANTE - IVR" || tipoEntrada === "LLAMADA ENTRANTE - TELEF.") {
                    processedRow["TIPO"] = "ENTRANTE";
                } else if (tipoEntrada === "LLAMADA SALIENTE") {
                    processedRow["TIPO"] = "SALIENTE";
                } else {
                    processedRow["TIPO"] = "PROCESOS BACKOFFICE";
                }

                processedRow["RESULTADO"] =
                    resultadoOriginal || "sin resultado valido";

                // Asegurar que existan todos los headers (por si en el futuro agregás campos)
                for (let k = 0; k < headersTemplate.length; k++) {
                    const header = headersTemplate[k];
                    if (!Object.prototype.hasOwnProperty.call(processedRow, header)) {
                        processedRow[header] = "";
                    }
                }

                // Ordenar las propiedades según headersTemplate
                const orderedRow = {};
                for (let k = 0; k < headersTemplate.length; k++) {
                    const header = headersTemplate[k];
                    orderedRow[header] = processedRow[header] || "";
                }

                resultadoFinal.push(orderedRow);
            }

            return resultadoFinal;
        }

        async function downloadExcel() {
            if (!processedData.length) {
                alert("No hay datos procesados para exportar.");
                return;
            }

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Datos");

            // Configurar columnas (misma lista de headers)
            worksheet.columns = headersTemplate.map(header => {
                // si quisieras formatear CI como número sin decimales:
                if (header === "CI") {
                    return { header, key: header, width: 15 };
                }
                return { header, key: header, width: 25 };
            });

            // Estilos de cabecera
            const headerStyle = {
                font: { bold: true, color: { argb: "FF000000" } },
                fill: { type: "pattern", pattern: "solid", fgColor: { argb: "FFD3D3D3" } },
                alignment: { horizontal: "center" },
                border: {
                    top: { style: "thin" },
                    left: { style: "thin" },
                    bottom: { style: "thin" },
                    right: { style: "thin" }
                }
            };

            worksheet.getRow(1).eachCell(cell => {
                cell.style = headerStyle;
            });

            // Agregar filas respetando el orden de headersTemplate
            for (let i = 0; i < processedData.length; i++) {
                const rowObj = processedData[i];
                const rowValues = headersTemplate.map(h => rowObj[h]);
                worksheet.addRow(rowValues);
            }

            // Bordes y ajuste de texto para todas las celdas
            worksheet.eachRow((row) => {
                row.eachCell(cell => {
                    cell.border = {
                        top: { style: "thin" },
                        left: { style: "thin" },
                        bottom: { style: "thin" },
                        right: { style: "thin" }
                    };
                    cell.alignment = { vertical: "middle", wrapText: true };
                });
            });

            const fileName = "ReporteCredicompras.xlsx";

            try {
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob(
                    [buffer],
                    { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }
                );
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Error generando el Excel:", error);
                alert("Ocurrió un error generando el Excel.");
            }
        }
    </script>
</body>

</html>