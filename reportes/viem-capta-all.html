<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            max-width: 800px;
        }

        .custom-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary,
        .btn-success {
            width: 100%;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/">Home</a>
                    </li>
                </ul>
            </div>
            <span class="navbar-text mx-auto fw-bold">CAPTA VIEMVENTURA</span>
        </div>
    </nav>

    <div class="container">
        <div class="row mt-5">
            <div class="col-md-6">
                <div class="custom-card mb-3">
                    <h5 class="text-center">Reporte Gestiones</h5>
                    <input type="file" id="csvInput2" class="form-control mb-3">
                    <button onclick="processCSVGestion()" class="btn btn-primary">Procesar Archivo</button>
                    <pre id="output2" class="mt-3 p-2 bg-light border" style="min-height: 50px;"></pre>
                </div>
            </div>
            <div class="col-md-6">
                <div class="custom-card mb-3">
                    <h5 class="text-center">Reporte IVR</h5>
                    <input type="file" id="csvInput1" class="form-control mb-3">
                    <button onclick="processIVR()" class="btn btn-primary">Procesar Archivo</button>
                    <pre id="output1" class="mt-3 p-2 bg-light border" style="min-height: 50px;"></pre>
                </div>
            </div>
        </div>

        <div class="custom-card text-center mb-2">
            <button onclick="downloadCombinedExcel()" class="btn btn-success mb-3">Descargar Excel Combinado</button>
        </div>
    </div>

    <script>
        "use strict";

        // =======================
        //      UTILIDADES
        // =======================
        function formatearfecha(date) {
            if (!date) return "";
            const dateParts = String(date).split(" ")[0].split("/");
            if (dateParts.length !== 3) return "";
            const [day, month, year] = dateParts;
            return `${String(day).padStart(2, "0")}/${String(month).padStart(2, "0")}/${year}`;
        }

        function formatearfechaSola(date) {
            const fecha = new Date(date);
            if (isNaN(fecha)) return "";
            const day = String(fecha.getDate()).padStart(2, "0");
            const month = String(fecha.getMonth() + 1).padStart(2, "0");
            const year = fecha.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatearfechaGestion(fechaStr) {
            if (!fechaStr) return "";
            const partes = String(fechaStr).split(" ");
            if (!partes.length) return "";

            const fechaPartes = partes[0].split("/");
            if (fechaPartes.length !== 3) return "";

            const dia = parseInt(fechaPartes[0], 10);
            const mes = parseInt(fechaPartes[1], 10) - 1;
            const anio = parseInt(fechaPartes[2], 10);

            const fecha = new Date(anio, mes, dia);
            if (isNaN(fecha.getTime())) return "";

            return `${dia.toString().padStart(2, "0")}/${(mes + 1).toString().padStart(2, "0")}/${anio}`;
        }

        function convertExcelDateToJSDate(excelDate) {
            if (!excelDate) return "";

            // numérico (fecha Excel)
            if (!isNaN(excelDate)) {
                const epochStart = new Date(1900, 0, 1);
                epochStart.setDate(epochStart.getDate() + (excelDate - 2));
                return epochStart.toLocaleDateString("es-ES");
            }

            // string "DD/MM/YYYY ..."
            if (typeof excelDate === "string" && excelDate.includes("/")) {
                const [fechaPart] = excelDate.split(" ");
                const [diaStr, mesStr, anioStr] = fechaPart.split("/");
                const dia = parseInt(diaStr, 10);
                const mes = parseInt(mesStr, 10);
                const anio = parseInt(anioStr, 10);

                const dateObj = new Date(anio, mes - 1, dia);
                if (isNaN(dateObj.getTime())) {
                    return "";
                }

                return `${diaStr.padStart(2, "0")}/${mesStr.padStart(2, "0")}/${anioStr}`;
            }

            return "";
        }

        function descomponerDescripcion(texto) {
            if (!texto) {
                return {
                    FECHApago: "",
                    MONTOcuota: "",
                    CANTIDADcuotas: "",
                    LUGARpago: "",
                    MONTOtotal: "",
                    MONTOant: "",
                    FECHAant: ""
                };
            }

            const regexFechaPago = /Primer vencimiento:\s*(\d{2}\/\d{2}\/\d{4})/;
            const regexMontoCuota = /Monto de cuota:\s*(\d+(?:\.\d{1,2})?)/;
            const regexCantidadCuotas = /Cantidad de cuota\/s:\s*(\d+)/;
            const regexLugarPago = /Lugar de pago:\s*([\w\s]+)/;
            const regexMontoTotal = /Deuda (?:máxima|mÃ¡xima) total:\s*(\d+(?:\.\d{1,2})?)/;
            const regexMontoAnticipo = /Monto del anticipo:\s*(\d+(?:\.\d{1,2})?)/;
            const regexFechaAnticipo = /Fecha del anticipo:\s*(\d{2}\/\d{2}\/\d{4})/;

            return {
                FECHApago: (texto.match(regexFechaPago) || [])[1] || "",
                MONTOcuota: (texto.match(regexMontoCuota) || [])[1] || "",
                CANTIDADcuotas: (texto.match(regexCantidadCuotas) || [])[1] || "",
                LUGARpago: ((texto.match(regexLugarPago) || [])[1] || "").trim(),
                MONTOtotal: (texto.match(regexMontoTotal) || [])[1] || "",
                MONTOant: (texto.match(regexMontoAnticipo) || [])[1] || "",
                FECHAant: (texto.match(regexFechaAnticipo) || [])[1] || ""
            };
        }

        function AgruparAgentes(ag) {
            if (
                ag === "riela.mario" ||
                ag === "fernanda.izquierdo" ||
                ag === "chiappini.camila" ||
                ag === "lacuesta.camila" ||
                ag === "castro.pilar" ||
                ag === "emiliano.correa"
            ) {
                return "maga_01";
            } else if (
                ag === "punciolo.romina" ||
                ag === "perugorria.fiamma" ||
                ag === "salles.martina"
            ) {
                return "maga_02";
            } else {
                return "maga_03";
            }
        }

        // =======================
        //   MAPEOS Y CONSTANTES
        // =======================
        const ResultadosMapping = {
            "Acuerdo libre": "Promesa de pago",
            "Aviso": "Contacto Directo",
            "Bajo acuerdo": "Promesa de pago",
            "Confirma acuerdo": "Promesa de pago",
            "Contactado": "Contacto Directo",
            "Equivocado": "No conoce al titular",
            "Fallecido": "Titular Fallecido",
            "Imposibilidad inmediata de pago": "Sin voluntad de pago",
            "Mensaje directo": "Contacto Directo",
            "No contesta": "No Contesta",
            "Pago a imputar": "Promesa de pago",
            "Fuera de servicio": "Fuera de servicio",
            "Mensaje indirecto": "Mensaje a tercero",
            "No tiene voluntad de arreglo": "Sin voluntad de pago",
            "Cambio de linea": "Busqueda de Datos",
            "No tiene dinero": "Sin voluntad de pago",
            "Ocupado": "Ocupado",
            "Acuerdo cumplido": "pago",
            "Imposible ubicar titular": "No conoce al titular",
            "No reconoce deuda": "No reconoce deuda",
            "Mensaje contestador": "Mensaje de voz",
            "Cancelado": "No se logra promesa de pago",
            "Dice que pago": "Aviso de Pago",
            "Se mudo": "Contacto con terceros",
            "ENVIO DE IVR": "No Contesta",
        };

        const EXCLUDED_KEYWORDS_GESTIONES = [
            "bienvenida",
            "recordatorio de cuota-maga",
            "recordatorio de cuota-welp fasa",
            "recordatorio de cuota-capta",
            "recordatorio de cuota-clearing",
            "reasignacion a usuario",
            "baja por pedido de entidad",
            "intimacion-maga",
            "imtimacion-capta",
            "cancelacion anterior",
            "anotacion"
        ];

        const EXCLUDED_USERS_GESTIONES = [
            "admi.orange",
            "baptista.nicolas",
            "bonilla.valentina",
            "carlos.olivera",
            "costa.belen",
            "cuna.marcos",
            "emiliano.correa",
            "sosa.martin",
            "sosas.martin",
            "supervisora.romina",
            "lencina.rosario",
            "supervisor.carlos",
            "trias.estefani",
            "veliz.romina",
            "supervisor.rosario",
            "sanchez.orhiana",
            "supervisora.maga",
            "tecnologia.carolain",
            "farias.daniela"
            // OJO: en tu código original, "Mango CRM :P" no se filtraba por el bug del índice.
            // Para mantener exactamente la misma lógica, no lo agrego aquí.
        ];

        // =======================
        //    ESTADO GLOBAL
        // =======================
        let processedData1 = []; // IVR
        let processedData2 = []; // gestiones
        let processedData3 = []; // acuerdos

        // =======================
        //      PROCESAR IVR
        // =======================
        function processIVR() {
            const fileInput = document.getElementById("csvInput1");
            const file = fileInput.files[0];

            if (!file) {
                alert("Por favor, selecciona un archivo Excel.");
                return;
            }

            if (!file.name.endsWith(".xlsx") && !file.name.endsWith(".xls")) {
                alert("Por favor, selecciona un archivo Excel válido.");
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });

                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                    processedData1 = json
                        .filter(row =>
                            row["resultado"] !== "NO LLAMADO" &&
                            row["resultado"] !== "SIN CANALES" &&
                            row["resultado"] !== "CONGESTION" &&
                            row["resultado"] !== "INVALIDO"
                        )
                        .map(row => ({
                            fecha: formatearfecha(row["fecha"]),
                            telefono: row["telefono"],
                            accion: "LLAMADA ENTRANTE - IVR",
                            resultados: "LLAMADA ENTRANTE - IVR",
                            observacion: "",
                            bcu: "Sin registro",
                            Trabajo: "Sin registro",
                            ci: (row["ci"] || "").toString().trim(),
                        }))
                        .filter(row => row.ci && row.fecha);

                    document.getElementById("output1").textContent =
                        `Archivos: ${processedData1.length} registros encontrados.`;
                } catch (error) {
                    console.error("Error procesando IVR:", error);
                    alert("Error procesando archivo IVR.");
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // =======================
        //   PROCESAR GESTIONES
        // =======================
        async function processCSVGestion() {
            const fileInput = document.getElementById("csvInput2");
            const file = fileInput.files[0];

            // Primero, acuerdos (mantenemos el orden de tu código)
            await processAcuerdos(file);

            if (!file) {
                alert("Por favor, selecciona un archivo CSV/Excel.");
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });

                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const inputData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                    const filteredData = inputData.filter(
                        row => row["entidades_35_cDescripcio"] === "CAPTA VIEMVENTURA"
                    );

                    const result = [];

                    for (let i = 0; i < filteredData.length; i++) {
                        const row = filteredData[i];

                        const resultadoLower = (row["resultados_22_cDescripcio"] || "").trim().toLowerCase();
                        const usuario = row["usuarios_21_cDescripcio"];

                        // excluir usuarios
                        if (EXCLUDED_USERS_GESTIONES.indexOf(usuario) !== -1) continue;

                        // excluir si contiene "de acuerdo" o "de cuenta"
                        if (resultadoLower.includes("de acuerdo") || resultadoLower.includes("de cuenta")) continue;

                        // excluir por keywords
                        let excluidoKeyword = false;
                        for (let j = 0; j < EXCLUDED_KEYWORDS_GESTIONES.length; j++) {
                            if (resultadoLower.includes(EXCLUDED_KEYWORDS_GESTIONES[j])) {
                                excluidoKeyword = true;
                                break;
                            }
                        }
                        if (excluidoKeyword) continue;

                        const resultadoOriginal = row["resultados_22_cDescripcio"];
                        result.push({
                            fecha: formatearfechaGestion(row["gestiones_dtEstado"]),
                            telefono: row["gestiones_cTelDiscad"],
                            accion: row["entrgest_20_cDescripcio"],
                            resultados: ResultadosMapping[resultadoOriginal] || "Resultado no contemplado",
                            observacion: row["gestiones_cObservaci"],
                            bcu: "Sin registro",
                            Trabajo: "Sin registro",
                            salario: "Sin registro",
                            agente: AgruparAgentes(usuario) || "",
                            ci: row["personas_nNumeDocu"],
                        });
                    }

                    processedData2 = result;

                    document.getElementById("output2").textContent =
                        `Archivos: ${processedData2.length} registros encontrados.`;
                } catch (error) {
                    console.error("Error procesando Gestiones:", error);
                    alert("Error procesando archivo de gestiones.");
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // =======================
        //   PROCESAR ACUERDOS
        // =======================
        function processAcuerdos(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    processedData3 = [];
                    resolve();
                    return;
                }

                const reader = new FileReader();

                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: "array" });

                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const inputData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                        const filteredData = inputData.filter(
                            row =>
                                row["entidades_35_cDescripcio"] === "CAPTA VIEMVENTURA" &&
                                row["resultados_22_cDescripcio"] === "Acuerdo libre"
                        );

                        const acuerdos = [];

                        for (let i = 0; i < filteredData.length; i++) {
                            const row = filteredData[i];
                            const descripcion = descomponerDescripcion(row["gestiones_cObservaci"]);
                            acuerdos.push({
                                fecha: convertExcelDateToJSDate(row["gestiones_dtEstado"]) || "",
                                ci: row["personas_nNumeDocu"] || "",
                                telefono: row["gestiones_cTelDiscad"] || "Sin registro",
                                entrega: descripcion.MONTOant !== "" ? descripcion.MONTOant : "0",
                                monto_cuota: descripcion.MONTOcuota || "",
                                cantidad_cuotas: descripcion.CANTIDADcuotas || "",
                                deuda_acordada: descripcion.MONTOtotal || "",
                                fecha_promesa: descripcion.FECHApago || "",
                                detalle:
                                    descripcion.MONTOant !== ""
                                        ? `Anticipo ${descripcion.MONTOant} + Convenio de ${descripcion.CANTIDADcuotas} CTAS de ${descripcion.MONTOcuota}`
                                        : `Convenio de ${descripcion.CANTIDADcuotas} CTAS de ${descripcion.MONTOcuota}`,
                                metodo_pago: descripcion.LUGARpago || "",
                            });
                        }

                        processedData3 = acuerdos;
                        resolve();
                    } catch (error) {
                        console.error("Error procesando Acuerdos:", error);
                        processedData3 = [];
                        resolve(); // mantengo comportamiento "best effort"
                    }
                };

                reader.onerror = (err) => {
                    console.error("Error leyendo archivo para Acuerdos:", err);
                    processedData3 = [];
                    resolve();
                };

                reader.readAsArrayBuffer(file);
            });
        }

        // =======================
        //  DESCARGAR EXCEL FINAL
        // =======================
        async function downloadCombinedExcel() {
            if (!processedData1.length && !processedData2.length) {
                alert("No hay datos para descargar. Procesa los archivos primero.");
                return;
            }

            const workbook = new ExcelJS.Workbook();

            // Hoja 1: Eventos
            const worksheet1 = workbook.addWorksheet("Eventos");
            const combinedData = processedData1.concat(processedData2);

            if (combinedData.length) {
                addDataToWorksheet(worksheet1, combinedData);
            } else {
                worksheet1.addRow(["No hay datos disponibles"]);
            }

            // Hoja 2: Acuerdos
            const worksheet2 = workbook.addWorksheet("Acuerdos");

            if (processedData3.length) {
                addDataToWorksheet(worksheet2, processedData3);
            } else {
                worksheet2.addRow(["No hay datos disponibles"]);
            }

            try {
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: "application/octet-stream" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "ReporteViemCapta.xlsx";
                link.click();
            } catch (err) {
                console.error("Error al generar el archivo Excel:", err);
                alert("Error generando el Excel.");
            }
        }

        function addDataToWorksheet(worksheet, data) {
            const headers = Object.keys(data[0] || {});
            if (!headers.length) {
                worksheet.addRow(["No hay datos disponibles"]);
                return;
            }

            const headerRow = worksheet.addRow(headers);

            headerRow.eachCell((cell) => {
                cell.font = { bold: true, color: { argb: "FFFFFFFF" } };
                cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FF002060" } };
                cell.alignment = { horizontal: "left" };
                cell.border = {
                    top: { style: "thin" },
                    left: { style: "thin" },
                    bottom: { style: "thin" },
                    right: { style: "thin" }
                };
            });

            // Filas de datos
            for (let i = 0; i < data.length; i++) {
                const rowData = data[i];
                const values = headers.map(h => rowData[h]);
                worksheet.addRow(values);
            }

            // Ajustar ancho de columnas (miramos como mucho 200 filas para no matar rendimiento)
            const MAX_ROWS_FOR_WIDTH = 200;

            worksheet.columns = headers.map((header, colIndex) => {
                let maxContentWidth = header.length;
                const limit = Math.min(data.length, MAX_ROWS_FOR_WIDTH);

                for (let i = 0; i < limit; i++) {
                    const value = data[i][header];
                    if (value == null) continue;
                    const text = String(value);
                    if (text.length > maxContentWidth) {
                        maxContentWidth = text.length;
                    }
                }

                return {
                    header,
                    key: header,
                    width: Math.min(maxContentWidth + 2, 30),
                };
            });
        }
    </script>
</body>

</html>
