<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cruce de Archivos Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            max-width: 600px;
        }

        .custom-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            width: 100%;
        }
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/">Home</a>
                    </li>
                </ul>
                <span class="navbar-text">
                    cruce por Cartera Clearing
                </span>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="container">
            <div class="custom-card">
                <h5 class="text-center mb-3">Subir Archivos para Cruce</h5>
                <p class="text-muted text-center">Seleccione los archivos correspondientes para realizar el cruce de
                    datos.</p>
                <div class="mb-3">
                    <label for="fileGestiones" class="form-label">Reporte sin Cartera (Clearing)</label>
                    <input type="file" id="fileGestiones" class="form-control" accept=".xlsx,.xls">
                </div>
                <div class="mb-3">
                    <label for="fileCartera" class="form-label">Reporte con Carteras/Productos</label>
                    <input type="file" id="fileCartera" class="form-control" accept=".xlsx,.xls">
                </div>
                <button class="btn btn-primary" onclick="procesarArchivos()">Procesar y Descargar</button>
            </div>
        </div>
    </div>

    <script>
        "use strict";

        async function procesarArchivos() {
            const fileGestiones = document.getElementById('fileGestiones').files[0];
            const fileCartera = document.getElementById('fileCartera').files[0];

            if (!fileGestiones || !fileCartera) {
                alert('Seleccione ambos archivos');
                return;
            }

            try {
                const [gestionesData, carteraData] = await Promise.all([
                    leerExcel(fileGestiones),
                    leerExcel(fileCartera)
                ]);

                if (!gestionesData.length || !carteraData.length) {
                    alert('Los archivos están vacíos o no contienen datos válidos');
                    return;
                }

                // Mapa DOC -> CARTERA (productos_40_cDescripcio)
                const documentosCartera = new Map();
                for (let i = 0; i < carteraData.length; i++) {
                    const row = carteraData[i];
                    const doc = row["personas_nNumeDocu"];
                    if (doc == null) continue; // evitar undefined/null
                    const docKey = String(doc).trim();
                    if (!docKey) continue;
                    documentosCartera.set(docKey, row["productos_40_cDescripcio"]);
                }

                // Asignar cartera en gestionesData
                for (let i = 0; i < gestionesData.length; i++) {
                    const row = gestionesData[i];
                    const doc = row["DOCUMENTO"];
                    if (doc == null) continue;
                    const docKey = String(doc).trim();
                    if (!docKey) continue;

                    if (documentosCartera.has(docKey)) {
                        row["CARTERA"] = documentosCartera.get(docKey);
                    }
                }

                descargarExcel(gestionesData, 'ReporteClearing.xlsx');

            } catch (error) {
                console.error("Error procesando los archivos:", error);
                alert("Ocurrió un error procesando los archivos. Ver consola para más detalles.");
            }
        }

        function leerExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        resolve(jsonData);
                    } catch (err) {
                        reject(err);
                    }
                };

                reader.onerror = (err) => {
                    reject(err);
                };

                reader.readAsArrayBuffer(file);
            });
        }

        function descargarExcel(data, filename) {
            if (!data || !data.length) {
                alert("No hay datos para generar el Excel.");
                return;
            }

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Datos");

            const headers = Object.keys(data[0] || {});
            if (!headers.length) {
                alert("No se pudieron determinar las columnas para el Excel.");
                return;
            }

            // Encabezados
            const headerRow = worksheet.addRow(headers);

            const headerStyle = {
                font: { bold: true, color: { argb: 'FFFFFFFF' } },
                fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF002060' } },
                alignment: { horizontal: 'left' },
                border: {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                }
            };

            headerRow.eachCell(cell => {
                cell.font = headerStyle.font;
                cell.fill = headerStyle.fill;
                cell.alignment = headerStyle.alignment;
                cell.border = headerStyle.border;
            });

            // Filas de datos (respetando el orden de headers)
            for (let i = 0; i < data.length; i++) {
                const rowObj = data[i];
                const rowValues = headers.map(h => rowObj[h]);
                worksheet.addRow(rowValues);
            }

            // Ajuste de ancho de columnas más eficiente:
            // miramos solo hasta 200 filas para no matar el rendimiento
            const MAX_ROWS_FOR_WIDTH = 200;

            worksheet.columns = headers.map((header) => {
                let maxContentWidth = header.length;
                const limit = Math.min(data.length, MAX_ROWS_FOR_WIDTH);

                for (let i = 0; i < limit; i++) {
                    const value = data[i][header];
                    if (value == null) continue;
                    const text = String(value);
                    if (text.length > maxContentWidth) {
                        maxContentWidth = text.length;
                    }
                }

                return {
                    header,
                    key: header,
                    width: Math.min(maxContentWidth + 2, 30)
                };
            });

            workbook.xlsx.writeBuffer()
                .then(buffer => {
                    const blob = new Blob(
                        [buffer],
                        { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }
                    );
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                })
                .catch(err => {
                    console.error("Error generando el archivo Excel:", err);
                    alert("Ocurrió un error generando el Excel. Ver consola para más detalles.");
                });
        }
    </script>
</body>

</html>
